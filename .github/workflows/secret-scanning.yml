name: Secret Scanning

# Least-privilege permissions (CI-004)
permissions:
  contents: read

# Run on all pushes and pull requests to detect secrets before they reach main branch
on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']
  # Also run weekly on a schedule to scan entire history
  schedule:
    - cron: '0 2 * * 1'  # Every Monday at 2 AM UTC

jobs:
  scan-secrets:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write  # For PR comments

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          fetch-depth: 0  # Fetch full history for comprehensive scanning

      - name: Run TruffleHog
        id: trufflehog
        uses: trufflesecurity/trufflehog@7f4e37db2d928c18ddd7ddf0604f8f7d1f5793ec # v3.93.0
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

      - name: Run GitLeaks
        id: gitleaks
        # GitLeaks v2+ requires GITLEAKS_LICENSE â€” skip if not configured
        if: env.GITLEAKS_LICENSE != ''
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7 # v2.3.9
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: Check results
        id: check
        run: |
          # Fail the workflow if any active scanner detected secrets (CI-005)
          TRUFFLEHOG_RESULT="${{ steps.trufflehog.outcome }}"
          GITLEAKS_RESULT="${{ steps.gitleaks.outcome }}"

          # GitLeaks is skipped when GITLEAKS_LICENSE is not configured
          if [ "$GITLEAKS_RESULT" == "skipped" ]; then
            echo "::notice::GitLeaks skipped (GITLEAKS_LICENSE not configured). TruffleHog is primary scanner."
          fi

          if [ "$TRUFFLEHOG_RESULT" == "failure" ] || [ "$GITLEAKS_RESULT" == "failure" ]; then
            echo "secrets_found=true" >> $GITHUB_OUTPUT
            echo "::error::Secrets detected by scanner. Review logs for details."
            exit 1
          else
            echo "secrets_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Alert on Discord (Secrets Found)
        if: failure() && env.DISCORD_WEBHOOK_URL != ''
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          # CI-003: Pass untrusted inputs via env vars to prevent shell injection
          GH_REPO: ${{ github.repository }}
          GH_REF: ${{ github.ref_name }}
          GH_SHA: ${{ github.sha }}
          GH_ACTOR: ${{ github.actor }}
        run: |
          # CI-003: Use jq for safe JSON construction instead of string interpolation
          PAYLOAD=$(jq -n \
            --arg repo "$GH_REPO" \
            --arg ref "$GH_REF" \
            --arg sha "$GH_SHA" \
            --arg actor "$GH_ACTOR" \
            --arg ts "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)" \
            '{
              content: "ðŸš¨ðŸš¨ðŸš¨ **CRITICAL: SECRETS DETECTED IN COMMIT**",
              embeds: [{
                title: "Secret Scanning Failed",
                description: ("Secrets were detected in repository: **" + $repo + "**"),
                color: 15158332,
                fields: [
                  { name: "Branch", value: $ref, inline: true },
                  { name: "Commit", value: $sha, inline: true },
                  { name: "Author", value: $actor, inline: true },
                  { name: "Action Required", value: "1. Rotate leaked secrets immediately\n2. Remove secrets from commit history\n3. Audit for unauthorized access\n4. See workflow logs for details" }
                ],
                footer: { text: "GitHub Secret Scanning" },
                timestamp: $ts
              }]
            }')
          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"

      - name: Alert on Discord (Success)
        if: success() && env.DISCORD_WEBHOOK_URL != ''
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          GH_REPO: ${{ github.repository }}
          GH_REF: ${{ github.ref_name }}
        run: |
          PAYLOAD=$(jq -n --arg repo "$GH_REPO" --arg ref "$GH_REF" \
            '{content: ("âœ… Secret scanning passed for **" + $repo + "** (" + $ref + ")")}')
          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"

      - name: Comment on PR (if applicable)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸš¨ Secret Scanning Failed

            Secrets were detected in this pull request. **This PR cannot be merged until the secrets are removed.**

            ### Immediate Actions Required:
            1. **DO NOT MERGE** this pull request
            2. Remove secrets from your code
            3. Rotate any exposed credentials
            4. Remove secrets from Git history if already committed
            5. Re-run the checks

            ### Tools Used:
            - TruffleHog
            - GitLeaks

            See the workflow logs for details on what was detected.

            ### Need Help?
            - See: \`grimoires/loa/runbooks/secrets-rotation.md\`
            - Contact: security team
            `
            })

      - name: Block PR merge
        if: failure() && github.event_name == 'pull_request'
        run: |
          echo "::error::Secrets detected in pull request. Merge blocked."
          exit 1

  # Additional job: Scan for secrets in dependencies
  # Only runs if app/package.json exists (skipped for template repos)
  scan-dependencies:
    name: Scan Dependencies for Vulnerabilities
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Check if app has dependencies
        id: check-deps
        run: |
          if [ -f "app/package.json" ]; then
            echo "has_deps=true" >> $GITHUB_OUTPUT
          else
            echo "has_deps=false" >> $GITHUB_OUTPUT
            echo "::notice::No app/package.json found - skipping dependency scan (template repo)"
          fi

      - name: Set up Node.js
        if: steps.check-deps.outputs.has_deps == 'true'
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'

      - name: Install dependencies
        if: steps.check-deps.outputs.has_deps == 'true'
        run: npm ci
        working-directory: ./app

      - name: Run npm audit
        if: steps.check-deps.outputs.has_deps == 'true'
        id: npm-audit
        continue-on-error: true
        run: |
          npm audit --audit-level=moderate --json > audit-results.json
          cat audit-results.json
        working-directory: ./app

      - name: Check for critical vulnerabilities
        if: steps.check-deps.outputs.has_deps == 'true'
        working-directory: ./app
        run: |
          CRITICAL_COUNT=$(cat audit-results.json | jq '.metadata.vulnerabilities.critical // 0')
          HIGH_COUNT=$(cat audit-results.json | jq '.metadata.vulnerabilities.high // 0')

          echo "Critical vulnerabilities: $CRITICAL_COUNT"
          echo "High vulnerabilities: $HIGH_COUNT"

          if [ "$CRITICAL_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 0 ]; then
            echo "::error::Found $CRITICAL_COUNT critical and $HIGH_COUNT high severity vulnerabilities"
            exit 1
          fi

      - name: Upload audit results
        if: always() && steps.check-deps.outputs.has_deps == 'true'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: npm-audit-results
          path: app/audit-results.json

# CONFIGURATION NOTES
# ===================
#
# Required Secrets (configure in GitHub Settings â†’ Secrets):
# - DISCORD_WEBHOOK_URL: Discord webhook for security alerts (optional)
# - GITLEAKS_LICENSE: GitLeaks Pro license key (optional)
#
# This workflow will:
# 1. Block pushes/PRs that contain secrets
# 2. Send Discord alerts when secrets detected
# 3. Comment on PRs with remediation instructions
# 4. Run weekly scans of entire repository history
# 5. Scan dependencies for vulnerabilities
#
# False Positives:
# - To exclude false positives, create .gitleaksignore or .trufflehog.yaml
# - Use git-secrets pre-commit hooks for local development
#
# Integration with Secrets Rotation:
# - This workflow integrates with secrets-leak-detector.ts
# - Detected leaks trigger emergency rotation procedures
# - See grimoires/loa/runbooks/secrets-rotation.md for rotation procedures
