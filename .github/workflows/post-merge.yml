name: Post-Merge Pipeline

# Triggers on push to main only (merge events)
on:
  push:
    branches: [main]

# Permissions required for tag creation, release, PR comments
permissions:
  contents: write
  pull-requests: write
  actions: read

# Prevent concurrent runs — queue newer pushes
concurrency:
  group: post-merge-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # =============================================================================
  # CLASSIFY — Determine PR type and route to appropriate pipeline
  # =============================================================================
  classify:
    name: Classify Merge
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.classify.outputs.pr_number }}
      pr_type: ${{ steps.classify.outputs.pr_type }}
      merge_sha: ${{ github.sha }}
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          fetch-depth: 0

      - name: Classify PR type
        id: classify
        env:
          GH_TOKEN: ${{ github.token }}
          MERGE_SHA: ${{ github.sha }}
        run: |
          MERGE_MSG=$(git log -1 --format='%s' "$MERGE_SHA")
          echo "Merge message: $MERGE_MSG"

          # Extract PR number from merge commit message
          PR_NUMBER=$(echo "$MERGE_MSG" | grep -oP '#\K[0-9]+' | head -1 || echo "")

          if [[ -z "$PR_NUMBER" ]]; then
            echo "No PR number found in commit message"
            echo "pr_number=" >> "$GITHUB_OUTPUT"
            echo "pr_type=other" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"

          # Fetch PR metadata
          PR_JSON=$(gh pr view "$PR_NUMBER" --json title,labels 2>/dev/null || echo '{}')
          TITLE=$(echo "$PR_JSON" | jq -r '.title // ""')
          LABELS=$(echo "$PR_JSON" | jq -r '[.labels[]?.name] | join(",")' 2>/dev/null || echo "")

          echo "PR title: $TITLE"
          echo "PR labels: $LABELS"

          # Classify based on labels first, then title
          if echo "$LABELS" | grep -qi "cycle"; then
            PR_TYPE="cycle"
          elif echo "$TITLE" | grep -qE "^(Run Mode|Sprint Plan|feat\(sprint|feat\(cycle)"; then
            PR_TYPE="cycle"
          elif echo "$TITLE" | grep -qE "^fix"; then
            PR_TYPE="bugfix"
          else
            PR_TYPE="other"
          fi

          echo "pr_type=$PR_TYPE" >> "$GITHUB_OUTPUT"
          echo "Classified as: $PR_TYPE"

  # =============================================================================
  # SIMPLE RELEASE — For bugfix/other PRs: semver + tag only (shell-only)
  # =============================================================================
  simple-release:
    name: Simple Release (Tag)
    needs: classify
    if: needs.classify.outputs.pr_type != 'cycle' && needs.classify.outputs.pr_number != ''
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Configure git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Compute semver
        id: semver
        run: |
          chmod +x .claude/scripts/semver-bump.sh .claude/scripts/bootstrap.sh
          RESULT=$(.claude/scripts/semver-bump.sh 2>/dev/null || echo '{}')
          NEXT=$(echo "$RESULT" | jq -r '.next // empty')
          BUMP=$(echo "$RESULT" | jq -r '.bump // empty')

          if [[ -z "$NEXT" ]]; then
            echo "Semver computation failed — skipping tag"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "next=$NEXT" >> "$GITHUB_OUTPUT"
          echo "bump=$BUMP" >> "$GITHUB_OUTPUT"
          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "Version: $NEXT ($BUMP)"

      - name: Create tag
        if: steps.semver.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="v${{ steps.semver.outputs.next }}"

          # Idempotency check
          if git tag -l "$TAG" | grep -q "$TAG"; then
            echo "Tag $TAG already exists — skipping"
            exit 0
          fi

          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"
          echo "Created tag: $TAG"

      - name: Post summary
        if: steps.semver.outputs.skip != 'true' && needs.classify.outputs.pr_number != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR="${{ needs.classify.outputs.pr_number }}"
          TAG="v${{ steps.semver.outputs.next }}"
          BODY="## Post-Merge: Simple Release\n\n| Phase | Result |\n|-------|--------|\n| Semver | ${{ steps.semver.outputs.next }} (${{ steps.semver.outputs.bump }}) |\n| Tag | ${TAG} |\n\n_Generated by Post-Merge Pipeline_"
          printf '%b' "$BODY" | gh pr comment "$PR" --body-file - 2>/dev/null || true

  # =============================================================================
  # FULL PIPELINE — For cycle PRs: claude-code-action orchestration
  # =============================================================================
  full-pipeline:
    name: Full Pipeline (Cycle)
    needs: classify
    if: needs.classify.outputs.pr_type == 'cycle'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          fetch-depth: 0

      - name: Configure git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check API key
        id: check-key
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          if [[ -z "$ANTHROPIC_API_KEY" ]]; then
            echo "ANTHROPIC_API_KEY not set — falling back to shell-only"
            echo "has_key=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_key=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Shell-only fallback
        if: steps.check-key.outputs.has_key != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          PM_PR_NUMBER: ${{ needs.classify.outputs.pr_number }}
          PM_MERGE_SHA: ${{ github.sha }}
        run: |
          echo "Running shell-only pipeline (no ANTHROPIC_API_KEY)"
          chmod +x .claude/scripts/post-merge-orchestrator.sh .claude/scripts/semver-bump.sh .claude/scripts/release-notes-gen.sh .claude/scripts/bootstrap.sh
          .claude/scripts/post-merge-orchestrator.sh \
            --pr "$PM_PR_NUMBER" \
            --type cycle \
            --sha "$PM_MERGE_SHA" \
            --skip-rtfm || true

      - name: Claude Code Action
        if: steps.check-key.outputs.has_key == 'true'
        uses: anthropics/claude-code-action@47635634fd56ccbdfc300003e8753607c2c135d3 # v1
        env:
          PM_PR_NUMBER: ${{ needs.classify.outputs.pr_number }}
          PM_PR_TYPE: ${{ needs.classify.outputs.pr_type }}
          PM_MERGE_SHA: ${{ github.sha }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          model: claude-sonnet-4-5-20250929
          max_turns: "15"
          allowed_tools: "Bash(bash),Read,Write,Glob,Grep"
          prompt: |
            You are running the Loa post-merge automation pipeline.

            Context:
            - PR number is in env var PM_PR_NUMBER
            - PR type is in env var PM_PR_TYPE
            - Merge SHA is in env var PM_MERGE_SHA

            Execute the pipeline:
            ```bash
            .claude/scripts/post-merge-orchestrator.sh \
              --pr "$PM_PR_NUMBER" \
              --type "$PM_PR_TYPE" \
              --sha "$PM_MERGE_SHA"
            ```

            If any phase fails, continue with the remaining phases.
            Report the final state JSON from .run/post-merge-state.json.

  # =============================================================================
  # NOTIFY — Post results and alert on failure
  # =============================================================================
  notify:
    name: Notify
    needs: [classify, simple-release, full-pipeline]
    if: always() && needs.classify.outputs.pr_number != ''
    runs-on: ubuntu-latest
    steps:
      - name: Discord notification on failure
        if: |
          (needs.simple-release.result == 'failure' || needs.full-pipeline.result == 'failure') &&
          env.DISCORD_WEBHOOK_URL != ''
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.MELANGE_DISCORD_WEBHOOK }}
        run: |
          PAYLOAD=$(jq -n \
            --arg pr "${{ needs.classify.outputs.pr_number }}" \
            --arg type "${{ needs.classify.outputs.pr_type }}" \
            --arg run "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --arg simple "${{ needs.simple-release.result }}" \
            --arg full "${{ needs.full-pipeline.result }}" \
            '{
              content: "⚠️ Post-merge pipeline failed for PR #\($pr) (\($type))\nSimple: \($simple) | Full: \($full)\nRun: \($run)"
            }')
          curl -s -H "Content-Type: application/json" -d "$PAYLOAD" "$DISCORD_WEBHOOK_URL" || true
